pipeline {
    agent any

    environment {
        // Set the name of your Helm chart
        CHART_NAME = 'myapp'
        // Set the version of your Helm chart
        CHART_VERSION = '1.0.0'
        // Set the AWS region where your ECR repository is located
        AWS_REGION = 'us-west-2'
        // Set the name of your ECR repository
        ECR_REPOSITORY = 'my-ecr-repository'
    }

    stages {
        stage('Build Helm Chart') {
            steps {
                // Build your Helm chart using any necessary build steps
                sh "helm package ${CHART_NAME} --version ${CHART_VERSION}"
            }
        }

        stage('Push Helm Chart to ECR') {
            steps {
                // Authenticate with AWS ECR
                withCredentials([awsEcr(credentialsId: 'my-ecr-credentials', region: "${AWS_REGION}")]) {
                    sh "aws ecr get-login-password | docker login --username AWS --password-stdin ${ECR_REPOSITORY}.dkr.ecr.${AWS_REGION}.amazonaws.com"
                }

                // Push the Helm chart to ECR
                sh "helm chart save ${CHART_NAME}-${CHART_VERSION}.tgz ${ECR_REPOSITORY}.dkr.ecr.${AWS_REGION}.amazonaws.com/${CHART_NAME}:${CHART_VERSION}"
                sh "helm chart push ${ECR_REPOSITORY}.dkr.ecr.${AWS_REGION}.amazonaws.com/${CHART_NAME}:${CHART_VERSION}"
            }
        }
    }
}
